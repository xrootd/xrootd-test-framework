<body>
<div id="fixed-wrapper" class="no-update">
       
    #set $nt = len($testsuites)
    #set $nc = len($clusters)
    #set $nh = len($hypervisors)
        
    #set $tcs = [t for t in $testsuites.itervalues() for t in t.tests]
    
    #set $ts_fail = [t for t in $testsuites.itervalues() if t.state.id < 0]
    #set $cl_fail = [c for c in $clusters.itervalues() if c.state.id < 0]
    
	#import re
	#from datetime import datetime
	
	#set $hist_keys = [k for k in sorted($all_runs.iterkeys())]
	#set $run_hist = $all_runs[$hist_keys[0]]
	
	#set $failed_runs = len([run for run in $run_hist if $run.failed])
	#set $success_runs = len($run_hist) - $failed_runs
	
	#def get_case_init_stages($all_stages)
	    #set $init_stages = []
	    #for $stage in $all_stages
	        #if re.match('\[..:..:..\] Initializing.*', $stage[1][0], re.I)
	            $init_stages.append($stage)
	        #end if
	    #end for
	    #return $init_stages
	#end def
	
	#def get_case_run_stages($all_stages)
	    #set $run_stages = []
	    #for $stage in $all_stages
	        #if re.match('^\[..:..:..\] Running.*', $stage[1][0], re.I)
	            $run_stages.append($stage)
	        #end if
	    #end for
	    #return $run_stages
	#end def
	
	#def get_case_finalize_stages($all_stages)
	    #set $finalize_stages = []
	    #for $stage in $all_stages
	        #if re.match('^\[..:..:..\] Finalizing.*', $stage[1][0], re.I)
	            $finalize_stages.append($stage)
	        #end if
	    #end for
	    #return $finalize_stages
	#end def
	
	#def has_action($stages)
	    #for $stage in $stages
	        #if self.participates($stage)
	            #return True
	        #end if
	    #end for
	    #return False
	#end def
	
	#def participates($stage)
	    #if re.search('.*Nothing to.*', $stage[1][0], re.I)
	        #return False
	    #else
	        #return True
	    #end if
	#end def
	
	#def has_failures($stages)
	    #for $stage in $stages
	        #if self.has_failure($stage)
	            return True
	        #end if
	    #end for
	#end def
	
	#def has_failure($stage)
	    #if $stage[1][2] != "0"
	        #return True
	    #end if
	    #return
	#end def
	
	#def format_log($log, custom=False)
	    #set $log = $log.decode('latin-1')
	    
	    #set $all = []
	    #set $important = []
	    #set $error = []
	    #set $warning = []
	    #set $success = []
	    
	    #for $i, $line in enumerate($log.split('\n'))
	        #set $line = $line.lstrip('\t')
	        
	        #if re.match(r'.*(error|err|fail|unable|cannot").*', $line, re.I)
	            #set $line = '<span class="error">' + $line + '</span>'
	            $error.append($line)
	            $important.append($line)
	        #end if
	        
	        
	        #if re.match(r'.*(ok|\[xrootd\]|complete|success).*', $line, re.I)
	            #set $line = '<span class="success">' + $line[:-1] + '</span>'
	            $success.append($line)
	            $important.append($line)
	        #end if
	        
            #if not $custom
    	        #if re.match(r'(?!<span.*>.*</span>)(?!\[..:..:..\])', $line, re.I)
    	            #set $line = '<span class="warning">' + $line + '</span>'
    	            $warning.append($line)
    	            $important.append($line)
    	        #end if
            #end if
            
            #if re.match(r'(?!<span.*>.*</span>)(warn)', $line, re.I)
                #set $line = '<span class="warning">' + $line + '</span>'
                $warning.append($line)
                $important.append($line)
            #end if
	        
	        $all.append($line)
	    #end for
	    
	    #set $all = '\n'.join([line for line in $all])
	    #set $important = '\n'.join([line for line in $important])
	    #set $error = '\n'.join([line for line in $error])
	    #set $warning = '\n'.join([line for line in $warning])
	    #set $success = '\n'.join([line for line in $success])
	    
	    #return { 
	                'all': $all, 
	                'important': $important, 
	                'error': $error, 
	                'warning': $warning, 
	                'success': $success
	            }     
	#end def

<!-- Aside Block -->
<section role="navigation">
    <header>
        <h1><a href="index" title="Back to Homepage"></a>XRootD</h1>
        <h2>Testing Framework</h2>
    </header>

    <!-- Main Navigation -->
    <nav id="main-nav">
        <ul>
            <!-- Use class .no-submenu to open link instead of a sub menu-->
            <!-- Use class .current to open submenu on page load -->
            <li>
                <a href="/index" class="dashboard no-submenu">Dashboard</a>
            </li>
            <li class="current">
                <a href="/testsuites" class="testsuite no-submenu">Test Suites</a>
                <span title="${nt} test suite(s) ${'('+str(len(ts_fail)) + 
                            ' defined incorrectly)' if len(ts_fail) else ''}" 
                      class="${'failure' if len($ts_fail) else 'success'}">
                      $nt
                </span>
                #if len($testsuites)
                    <ul>
                        #for $ts_name in $testsuites.iterkeys()
                            <li><a href="/testsuites/${ts_name}">$ts_name</a></li>
                        #end for
                    </ul>
                #end if
            </li>
            <li>
                <a href="/clusters" class="cluster no-submenu">Clusters</a>
                <span title="${nc} defined cluster(s) ${'('+str(len(ts_fail)) + 
                            ' defined incorrectly)' if len(ts_fail) else ''}"
                      class="${'failure' if len($cl_fail) else 'success'}">
                      $nc
                </span>
            </li>
            <li>
                <a href="/hypervisors" class="hypervisor no-submenu">Hypervisors</a>
                <span title="${nh} connected hypervisor(s)">$nh</span>
            </li>
        </ul>
    </nav>
    <!-- /Main Navigation -->
    
    <footer>
        <p>
            Copyright &copy; <a href="http://cern.ch">CERN</a>
        </p><br />
        <span class="valid-images">
            <img src="/webpage/img/valid_html5.png" alt="HTML5 valid"/>
            <img src="/webpage/img/valid_css3.png" alt="CSS3 valid"/>
        </span>
    </footer>

</section>
<!-- /Aside Block -->

<!-- Main Content -->
<section role="main">

    <!-- Breadcrumbs -->
    <ul id="breadcrumbs">
        <li><a href="/index" title="Back to Homepage">Back to Home</a></li>
        <li><a href="/index">Dashboard</a></li>
        <li><a href="/testsuites">Test Suites</a></li>
        <li>${testsuite.name if hasattr($testsuite, 'name') else ''}</li>
    </ul>
    <!-- /Breadcrumbs -->
    
    <section id="corner-stats">
        <span>
            Currently active cluster:&nbsp;
            <strong>
                #set $ac = [c for c in $clusters.itervalues() if 0 < c.state.id < 11 ]
                ${ac[0].name if len(ac) else 'None'}
            </strong>
            #if len($hypervisors) and len($ac)
                #set $ah = [h for h in $hypervisors.values() if 0 < h.state.id < 11 ]
                ${'on hypervisor <strong>%s</strong>' % ah[0].hostname if len(ah) else 'None'}
            #end if 
        </span>
        <br />
        <span>
            Currently running test suite:&nbsp;
            <strong>${$current_run.name if $current_run else 'None'}&nbsp;</strong>
        </span>
    </section>

    <!-- Full Content Block -->
    <!-- Note that only 1st article need clearfix class for clearing -->
    <article class="full-block clearfix">
    #if $testsuite and hasattr($testsuite, 'name')
        <!-- Article Container for safe floating -->
        <div class="article-container">
            <header>
                <h2>Run History : $testsuite.name</h2>
                <!-- Article Header Tab Navigation -->
                <nav>
                    <form action="/action" method="post">
                        #set $runnable = 'disabled' if $testsuite.state.id < 0 or $current_run and $current_run.name else ''
                        <button name="type" value="run" $runnable>Run Now</button>
                        #set $cancelable = '' if $current_run and $current_run.name == $testsuite.name else 'disabled'
                        <button name="type" value="cancel" $cancelable>Cancel Run</button>
                        
                        <input type="hidden" id='testsuite' name="testsuite" value="$testsuite.name" />
                        <input type="hidden" id='location' name="location" value="" />
                    </form>
                </nav>
                <!-- /Article Header Tab Navigation -->

            </header>
            <!-- /Article Header -->

            <!-- Article Content -->
            <section>
                <!-- Tab Content -->
                    #if len($run_hist)
                        <div class="sidetabs thin">
                        
                        <!-- Side Tab Navigation -->
                        <nav class="sidetab-switch">
                            <ul>
                                #set $default_tab = True
                                #for $i, $run in enumerate($run_hist)
                                    
                                    <li class="${'failure' if $run.failed else 'success'}">
                                        <a class="${'default-sidetab' if $default_tab else ''}" 
                                           href="#sidetab-outer-${run.uid}">
                                            $run.initDate.strftime("%d-%m-%Y %H:%M:%S")
                                        </a>
                                    </li>
                                    #set $default_tab = False
                                #end for
                            </ul>
                        </nav>
                    #else
                        <div class="notification note">
                            <p>
                                <strong>Note:</strong> No historical runs for this test suite.
                            </p>
                        </div>
                    #end if
                        
                        <!-- /Side Tab Navigation -->
                        
                        #if len($run_hist)
                        
                            #set $default_outer_tab = True         
                            #for $i, $run in enumerate($run_hist)
                                
                                <div class="sidetab ${'default-sidetab' if $default_outer_tab else ''}" 
                                     id="sidetab-outer-${run.uid}">
                                    
                                    #set $default_outer_tab = False
                                    <div class="widgets">
                                        <div class="widget increase" id="successes">
                                            <span>$success_runs</span>
                                            <p>Successful Run(s)</p>
                                        </div>
                                        
                                        <div class="widget decrease" id="failures">
                                            <span>$failed_runs</span>
                                            <p>Failed Run(s)</p>
                                        </div>
                                    </div>
                                    
                                    <h4>
                                        Run started: <span>$run.initDate.strftime("%a %d-%m-%Y %H:%M:%S")</span>
                                        #if $run.timeout
                                            <span class="tag red timeout">Timed Out</span>
                                        #end if
                                    </h4>
                                    
                                    <header class="square">
                                        <!-- Article Header Tab Navigation -->
                                        <nav class="leftnav">
                                            <ul class="tab-switch">
                                                #set $init_stages = $run.getTestCaseStages("suite_inited")
                                                #set $failure = self.has_failures($init_stages)
                                                <li class="${'failure' if $failure else 'success'}">
                                                    <a class="default-tab" href="#tab-suite-init-${run.uid}">Suite Initialization</a>
                                                </li>
                                                
                                                #set $failure = False
                                                #for $i, $case in enumerate($run.cases.itervalues())        
                                                    #set $case_stages = $run.getTestCaseStages($case.uid)
                                                    #if self.has_failures($case_stages)
                                                        #set $failure = True
                                                    #end if
                                                #end for
                                                
                                                <li class="${'failure' if $failure else 'success'}">
                                                    <a href="#tab-case-run-${run.uid}">Test Cases</a>
                                                </li>
                                                
                                                #set $fin_stages = $run.getTestCaseStages("suite_finalized")
                                                #set $failure = self.has_failures($fin_stages)
                                                <li class="${'failure' if $failure else 'success'}">
                                                    <a href="#tab-suite-fin-${run.uid}">Suite Finalization</a>
                                                </li>
                                            </ul>
                                        </nav>
                                    </header>
                                    
                                    <section>
                                        <div class="tab default-tab" id="tab-suite-init-${run.uid}">
                                            #set $init_stages = $run.getTestCaseStages("suite_inited") 
                                            #if $init_stages and len($init_stages)
                                               <div class="sidetabs thin">
                                                    <nav class="sidetab-switch">
                                                        <ul>
                                                            #set $default_tab = True
                                                            #for $i, $stage in enumerate($init_stages)
                                                                
                                                                #if self.participates($stage)
                                                                    #set $failure = self.has_failure($stage)
                                                                    #set $host = $stage[3].replace('.', '-')
                                                                    <li class="${'failure' if $failure else 'success'}">
                                                                        <a href="#sidetab-inner-suite-init-${host}-${run.uid}" 
                                                                           class="${'default-sidetab' if $default_tab else ''}">
                                                                            $stage[3]
                                                                        </a>
                                                                    </li>
                                                                    #set $default_tab = False
                                                                #end if
                                                            
                                                            #end for
                                                        </ul>
                                                    </nav>
                                                    
                                                    <section>
                                                    #set $default_tab = True
                                                    #for $i, $stage in enumerate($init_stages)
                                                        #set $host = $stage[3].replace('.', '-')
                                                        
                                                        #if self.participates($stage)
                                                            <div class="sidetab ${'default-sidetab' if $default_tab else ''}" 
                                                                 id="sidetab-inner-suite-init-${host}-${run.uid}">        
                                                                <article class="full-block nested light">                                       
                                                                    <div class="article-container">
                                                                       <section>
                                                                          
                                                                            <header>
                                                                                <h2><span>initialized at $stage[0].time[:8] with return code $stage[1][2]</span></h2>
                                                                                
                                                                                <nav class="log-select">
                                                                                    <ul class="tab-switch">
                                                                                        <li>
                                                                                        <a class="default-tab" href="#tab-log-init-${host}-${run.uid}-default-all">All</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-init-${host}-${run.uid}-default-important">Important</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-init-${host}-${run.uid}-default-error">Errors</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-init-${host}-${run.uid}-default-warning">Warnings</a>
                                                                                        </li>
                                                                                    </ul>
                                                                                </nav>
                                                                                
                                                                            </header>
                                                                            
                                                                            <section>
                                                                                <form class="log-select">
                                                                                    <label for="whichlog">Select Log:&nbsp;</label>
                                                                                    <select id="whichlog">
                                                                                        
                                                                                        <option class="default-option"
                                                                                                value="tab-log-init-$host-$run.uid-default">
                                                                                            Session Log
                                                                                        </option>
                                                                                        
                                                                                        #for $i, $logname in enumerate($stage[1][3].iterkeys())
                                                                                            <option value="tab-log-init-$host-$run.uid-$i">
                                                                                                $logname
                                                                                            </option>
                                                                                        #end for
                                                                                    </select>
                                                                                </form>
                                                                            </section>
                                                                            
                                                                            #set $logs = self.format_log($stage[1][0])
                                                                            <section>
                                                                                <div class="tab default-tab default-log" id="tab-log-init-${host}-${run.uid}-default-all">
                                                                                    <code>$logs['all']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-init-${host}-${run.uid}-default-important">
                                                                                    <code>$logs['important']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-init-${host}-${run.uid}-default-error">
                                                                                    <code>$logs['error']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-init-${host}-${run.uid}-default-warning">
                                                                                    <code>$logs['warning']</code>
                                                                                </div>
                                                                            </section>
                                                                            
                                                                            
                                                                            #for $i, $log in enumerate($stage[1][3].itervalues())
                                                                                #set $logs = self.format_log($log, custom=True)
                                                                                <section>
                                                                                    <div class="tab default-log" id="tab-log-init-${host}-${run.uid}-$i-all">
                                                                                        <code>$logs['all']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-init-${host}-${run.uid}-$i-important">
                                                                                        <code>$logs['important']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-init-${host}-${run.uid}-$i-error">
                                                                                        <code>$logs['error']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-init-${host}-${run.uid}-$i-warning">
                                                                                        <code>$logs['warning']</code>
                                                                                    </div>
                                                                                </section>
                                                                            #end for
                                                                            
                                                                       </section>
                                                                    </div>
                                                                </article>     
                                                            </div>
                                                            #set $default_tab = False
                                                        #end if
                                                        
                                                    #end for
                                                    </section>
                                                </div>
                                            #else
                                                <div class="notification note">
                                                    <p>
                                                        <strong>Note:</strong> No suite initialization information.
                                                    </p>
                                                </div>
                                            #end if                    

                                        </div>   
                                        
                                        <div class="tab" id="tab-case-run-${run.uid}">
                                            #if $run.cases
                                            <form>
                                                <select name="testcases" id="imgselect-${run.uid}">
                                                    #for $i, $case in enumerate($run.cases.itervalues())
                                                        #set $case_stages = $run.getTestCaseStages($case.uid)
                                                        #set $failure = self.has_failures($case_stages)
                                                        <option value="tab-case-run-${case.uid}"
                                                                 data-imageSrc="${'/webpage/img/icons/list-style/icon_list_style_cross.png'
                                                                                   if $failure else
                                                                                   '/webpage/img/icons/list-style/icon_list_style_checkmark.png'}">
                                                            $case.name
                                                        </option>
                         
                                                    #end for
                                                    
                                                </select>
                                            </form>
                                            <section>
                                                #set $default_tab = True
                                                #for $i, $case in enumerate($run.cases.itervalues())
                                                    #set $case_stages = $run.getTestCaseStages($case.uid)
                                                    <div class="tab ${'default-tab' if $default_tab else ''}" id="tab-case-run-${case.uid}">
                                                        
                                                        <header class="small">
                                                            <nav class="leftnav">
                                                                  <ul class="tab-switch">
                                                                      
                                                                      #set $init_stages = self.get_case_init_stages($case_stages)
                                                                      #set $failure = self.has_failures($init_stages)
                                                                      <li class="${'failure' if $failure else 'success'}">
                                                                          <a href="#tab-inner-case-init-${case.uid}" class="default-tab">Initialization</a>
                                                                      </li>
                                                                      
                                                                      #set $run_stages = self.get_case_run_stages($case_stages)
                                                                      #set $failure = self.has_failures($run_stages)
                                                                      <li class="${'failure' if $failure else 'success'}">
                                                                          <a href="#tab-inner-case-run-${case.uid}">Run</a>
                                                                      </li>
                                                                      
                                                                      #set $fin_stages = self.get_case_finalize_stages($case_stages)
                                                                      #set $failure = self.has_failures($fin_stages)
                                                                      <li class="${'failure' if $failure else 'success'}">
                                                                          <a href="#tab-inner-case-fin-${case.uid}">Finalization</a>
                                                                      </li>
                                                                      
                                                                  </ul>
                                                            </nav>
                                                        </header>
                                                        
                                                        <section>
                                                            <div class="tab default-tab" id="tab-inner-case-init-${case.uid}">
                                                                
                                                                #set $init_stages = self.get_case_init_stages($case_stages)
                                                                   #if len($init_stages)
                                                                       <div class="sidetabs thin">
                                                                        <nav class="sidetab-switch">
                                                                            <ul>
                                                                                #set $default_tab = True
                                                                                #for $i, $stage in enumerate($init_stages)
                            
                                                                                    #if self.participates($stage)
                                                                                        #set $failure = self.has_failure($stage)
                                                                                        #set $host = $stage[3].replace('.', '-')
                                                                                        <li class="${'failure' if $failure else 'success'}">
                                                                                           <a href="#sidetab-inner-case-init-${host}-${case.uid}"
                                                                                              class="${'default-sidetab' if $default_tab else ''}">
                                                                                              $stage[3]
                                                                                           </a>
                                                                                        </li>
                                                                                        #set $default_tab = False
                                                                                    #end if
                                                                                #end for
                                                                            </ul>
                                                                        </nav>
                                                                    
                                                                        <section>
                                                                            #set $default_tab = True 
                                                                            #for $i, $stage in enumerate($init_stages)
                                                                                #set $host = $stage[3].replace('.', '-')
                                                                                
                                                                                #if self.participates($stage)
                                                                                    <div class="sidetab ${'default-sidetab' if $default_tab else ''}" 
                                                                                         id="sidetab-inner-case-init-${host}-${case.uid}">
                                                                                        
                                                                                        <h4>$case.name</h4>
                                                                                        <article class="full-block nested light">                                       
                                                                                            <div class="article-container">
                                                                                            <section>
                                                                                                  
                                                                                                    <header>
                                                                                                        <h2><span>initialized at $stage[0].time[:8] with return code $stage[1][2]</span></h2>
                                                                                                        <nav class="log-select">
                                                                                                            <ul class="tab-switch">
                                                                                                                <li>
                                                                                                                <a class="default-tab" href="#tab-log-case-init-${host}-${case.uid}-default-all">All</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-init-${host}-${case.uid}-default-important">Important</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-init-${host}-${case.uid}-default-error">Errors</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-init-${host}-${case.uid}-default-warning">Warnings</a>
                                                                                                                </li>
                                                                                                            </ul>
                                                                                                        </nav>
                                                                                                        
                                                                                                        
                                                                                                    </header>
                                                                                                    <section>
                                                                                                        <form class="log-select">
                                                                                                            <label for="whichlog">Select Log:&nbsp;</label>
                                                                                                            <select id="whichlog">
                                                                                                                
                                                                                                                <option class="default-option"
                                                                                                                        value="tab-log-case-init-$host-$case.uid-default">
                                                                                                                    Session Log
                                                                                                                </option>
                                                                                                                
                                                                                                                #for $i, $logname in enumerate($stage[1][3].iterkeys())
                                                                                                                    <option value="tab-log-case-init-$host-$case.uid-$i">
                                                                                                                        $logname
                                                                                                                    </option>
                                                                                                                #end for
                                                                                                            </select>
                                                                                                        </form>
                                                                                                    </section>
                                                                                                    
                                                                                                    #set $logs = self.format_log($stage[1][0])
                                                                                                        <section>
                                                                                                            <div class="tab default-tab default-log" id="tab-log-case-init-${host}-${case.uid}-default-all">
                                                                                                                <code>$logs['all']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-init-${host}-${case.uid}-default-important">
                                                                                                                <code>$logs['important']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-init-${host}-${case.uid}-default-error">
                                                                                                                <code>$logs['error']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-init-${host}-${case.uid}-default-warning">
                                                                                                                <code>$logs['warning']</code>
                                                                                                            </div>
                                                                                                        </section>
                                                                                                        
                                                                                                        
                                                                                                        #for $i, $log in enumerate($stage[1][3].itervalues())
                                                                                                            #set $logs = self.format_log($log, custom=True)
                                                                                                            <section>
                                                                                                                <div class="tab default-log" id="tab-log-case-init-${host}-${case.uid}-$i-all">
                                                                                                                    <code>$logs['all']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-init-${host}-${case.uid}-$i-important">
                                                                                                                    <code>$logs['important']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-init-${host}-${case.uid}-$i-error">
                                                                                                                    <code>$logs['error']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-init-${host}-${case.uid}-$i-warning">
                                                                                                                    <code>$logs['warning']</code>
                                                                                                                </div>
                                                                                                            </section>
                                                                                                        #end for
                                                                                               
                                                                                               </section>
                                                                                            </div>
                                                                                        </article>
                                                                                    </div>
                                                                                    #set $default_tab = False
                                                                                #end if                                                                                    
                                                                            #end for
                                                                        </section>
                                                                    </div>
                                                                    #else
                                                                        <div class="notification note">
                                                                            <p>
                                                                                <strong>Note:</strong> No test case initialization information.
                                                                            </p>
                                                                        </div>
                                                                    #end if 
                                                            </div>
                                                            
                                                            <div class="tab" id="tab-inner-case-run-${case.uid}">
                                                                #set $run_stages = self.get_case_run_stages($case_stages)
                                                                
                                                                #if len($run_stages)
                                                                    <div class="sidetabs thin">
                                                                        <nav class="sidetab-switch">
                                                                            <ul>
                                                                                #set $default_tab = True
                                                                                #for $i, $stage in enumerate($run_stages)
        
                                                                                    #if self.participates($stage)
                                                                                        #set $failure = self.has_failure($stage)
                                                                                        #set $host = $stage[3].replace('.', '-')
                                                                                        <li class="${'failure' if $failure else 'success'}">
                                                                                           <a href="#sidetab-inner-case-run-${host}-${case.uid}"
                                                                                              class="${'default-sidetab' if $default_tab else ''}">
                                                                                               $stage[3]
                                                                                           </a>
                                                                                        </li>
                                                                                        #set $default_tab = False
                                                                                    #end if
                                                                                #end for
                                                                            </ul>
                                                                        </nav>
                                                                        
                                                                        <section>
                                                                            #set $default_tab = True     
                                                                            #for $i, $stage in enumerate($run_stages)
                                                                                #set $host = $stage[3].replace('.', '-')
                                                                                
                                                                                #if self.participates($stage)
                                                                                    <div class="sidetab ${'default-sidetab' if $default_tab else ''}" 
                                                                                         id="sidetab-inner-case-run-${host}-${case.uid}">
                                                                                        <article class="full-block nested light">                                       
                                                                                            <div class="article-container">
                                                                                            <section>
                                                                                                  
                                                                                                    <header>
                                                                                                        <h2><span>run at $stage[0].time[:8] with return code $stage[1][2]</span></h2>
                                                                                                        <nav class="log-select">
                                                                                                            <ul class="tab-switch">
                                                                                                                <li>
                                                                                                                <a class="default-tab" href="#tab-log-case-run-${host}-${case.uid}-default-all">All</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-run-${host}-${case.uid}-default-important">Important</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-run-${host}-${case.uid}-default-error">Errors</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-run-${host}-${case.uid}-default-warning">Warnings</a>
                                                                                                                </li>
                                                                                                            </ul>
                                                                                                        </nav>
                                                                                                        
                                                                                                    </header>
                                                                                                    
                                                                                                    <section>
                                                                                                        <form class="log-select">
                                                                                                            <label for="whichlog">Select Log:&nbsp;</label>
                                                                                                            <select id="whichlog">
                                                                                                                
                                                                                                                <option class="default-option"
                                                                                                                        value="tab-log-case-run-$host-$case.uid-default">
                                                                                                                    Session Log
                                                                                                                </option>
                                                                                                                
                                                                                                                #for $i, $logname in enumerate($stage[1][3].iterkeys())
                                                                                                                    <option value="tab-log-case-run-$host-$case.uid-$i">
                                                                                                                        $logname
                                                                                                                    </option>
                                                                                                                #end for
                                                                                                            </select>
                                                                                                        </form>
                                                                                                    </section>
                                                                                                    
                                                                                                    #set $logs = self.format_log($stage[1][0])
                                                                                                        <section>
                                                                                                            <div class="tab default-tab default-log" id="tab-log-case-run-${host}-${case.uid}-default-all">
                                                                                                                <code>$logs['all']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-run-${host}-${case.uid}-default-important">
                                                                                                                <code>$logs['important']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-run-${host}-${case.uid}-default-error">
                                                                                                                <code>$logs['error']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-run-${host}-${case.uid}-default-warning">
                                                                                                                <code>$logs['warning']</code>
                                                                                                            </div>
                                                                                                        </section>
                                                                                                        
                                                                                                        
                                                                                                        #for $i, $log in enumerate($stage[1][3].itervalues())
                                                                                                            #set $logs = self.format_log($log, custom=True)
                                                                                                            <section>
                                                                                                                <div class="tab default-log" id="tab-log-case-run-${host}-${case.uid}-$i-all">
                                                                                                                    <code>$logs['all']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-run-${host}-${case.uid}-$i-important">
                                                                                                                    <code>$logs['important']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-run-${host}-${case.uid}-$i-error">
                                                                                                                    <code>$logs['error']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-run-${host}-${case.uid}-$i-warning">
                                                                                                                    <code>$logs['warning']</code>
                                                                                                                </div>
                                                                                                            </section>
                                                                                                        #end for
                                                                                               
                                                                                               </section>
                                                                                            </div>
                                                                                        </article>
                                                                                    </div>
                                                                                    #set $default_tab = False
                                                                                #end if
                                                                            #end for
                                                                        </section>
                                                                    </div>
                                                                #else
                                                                    <div class="notification note">
                                                                        <p>
                                                                            <strong>Note:</strong> No test case run information.
                                                                        </p>
                                                                    </div>
                                                                #end if 
                                                                
                                                            </div>
                                                            
                                                            <div class="tab" id="tab-inner-case-fin-${case.uid}">
                                                                #set $fin_stages = self.get_case_finalize_stages($case_stages)
                                                                
                                                                #if len($fin_stages) and self.has_action($fin_stages)
                                                                    <div class="sidetabs thin">
                                                                        <nav class="sidetab-switch">
                                                                            <ul>
                                                                                #set $default_tab = True
                                                                                #for $i, $stage in enumerate($fin_stages)
                                                                                    
                                                                                    #if self.participates($stage)
                                                                                        #set $failure = self.has_failure($stage)
                                                                                        #set $host = $stage[3].replace('.', '-')
                                                                                        <li class="${'failure' if $failure else 'success'}">
                                                                                           <a href="#sidetab-inner-case-fin-${host}-${case.uid}"
                                                                                              class="${'default-sidetab' if $default_tab else ''}">
                                                                                               $stage[3]
                                                                                           </a>
                                                                                        </li>
                                                                                        #set $default_tab = False
                                                                                    #end if
                                                                                #end for
                                                                            </ul>
                                                                        </nav>
                                                                        
                                                                        <section>
                                                                            #set $default_tab = True
                                                                            #for $i, $stage in enumerate($fin_stages)
                                                                                #set $host = $stage[3].replace('.', '-')
                                                                                
                                                                                #if self.participates($stage)
                                                                                    <div class="sidetab ${'default-sidetab' if $default_tab else ''}" 
                                                                                         id="sidetab-inner-case-fin-${host}-${case.uid}">
                                                                                        <article class="full-block nested light">                                       
                                                                                            <div class="article-container">
                                                                                            <section>
                                                                                                  
                                                                                                    <header>
                                                                                                        <h2><span>finalized at $stage[0].time[:8] with return code $stage[1][2]</span></h2>
                                                                                                        <nav class="log-select">
                                                                                                            <ul class="tab-switch">
                                                                                                                <li>
                                                                                                                <a class="default-tab" href="#tab-log-case-fin-${host}-${case.uid}-default-all">All</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-fin-${host}-${case.uid}-default-important">Important</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-fin-${host}-${case.uid}-default-error">Errors</a>
                                                                                                                </li>
                                                                                                                <li>
                                                                                                                <a href="#tab-log-case-fin-${host}-${case.uid}-default-warning">Warnings</a>
                                                                                                                </li>
                                                                                                            </ul>
                                                                                                        </nav>
                                                                                                         
                                                                                                    </header>
                                                                                                    
                                                                                                    <section>
                                                                                                        <form class="log-select">
                                                                                                            <label for="whichlog">Select Log:&nbsp;</label>
                                                                                                            <select id="whichlog">
                                                                                                                
                                                                                                                <option class="default-option"
                                                                                                                        value="tab-log-case-fin-$host-$case.uid-default">
                                                                                                                    Session Log
                                                                                                                </option>
                                                                                                                
                                                                                                                #for $i, $logname in enumerate($stage[1][3].iterkeys())
                                                                                                                    <option value="tab-log-case-fin-$host-$case.uid-$i">
                                                                                                                        $logname
                                                                                                                    </option>
                                                                                                                #end for
                                                                                                            </select>
                                                                                                        </form>
                                                                                                    </section>
                                                                                                    
                                                                                                    #set $logs = self.format_log($stage[1][0])
                                                                                                        <section>
                                                                                                            <div class="tab default-tab default-log" id="tab-log-case-fin-${host}-${case.uid}-default-all">
                                                                                                                <code>$logs['all']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-default-important">
                                                                                                                <code>$logs['important']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-default-error">
                                                                                                                <code>$logs['error']</code>
                                                                                                            </div>
                                                                                                            <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-default-warning">
                                                                                                                <code>$logs['warning']</code>
                                                                                                            </div>
                                                                                                        </section>
                                                                                                        
                                                                                                        
                                                                                                        #for $i, $log in enumerate($stage[1][3].itervalues())
                                                                                                            #set $logs = self.format_log($log, custom=True)
                                                                                                            <section>
                                                                                                                <div class="tab default-log" id="tab-log-case-fin-${host}-${case.uid}-$i-all">
                                                                                                                    <code>$logs['all']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-$i-important">
                                                                                                                    <code>$logs['important']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-$i-error">
                                                                                                                    <code>$logs['error']</code>
                                                                                                                </div>
                                                                                                                <div class="tab" id="tab-log-case-fin-${host}-${case.uid}-$i-warning">
                                                                                                                    <code>$logs['warning']</code>
                                                                                                                </div>
                                                                                                            </section>
                                                                                                        #end for
                                                                                               
                                                                                               </section>
                                                                                            </div>
                                                                                        </article>
                                                                                    </div>
                                                                                    #set $default_tab = False
                                                                                #end if
                                                                            #end for
                                                                        </section>
                                                                    </div>
                                                                #else
                                                                    <div class="notification note">
                                                                        <p>
                                                                            <strong>Note:</strong> No test case finalization information.
                                                                        </p>
                                                                    </div>
                                                                #end if 
                                                                
                                                            </div>
                                                        </section>
        
                                                    </div>  
                                                    #set $default_tab = False
                                                #end for
                                            </section>
                                            #else
                                                <div class="notification note">
                                                    <p>
                                                        <strong>Note:</strong> No test case information.
                                                    </p>
                                                </div>
                                            #end if
                                        </div>
        
                                        <div class="tab" id="tab-suite-fin-${run.uid}">
                                            #set $fin_stages = $run.getTestCaseStages("suite_finalized") 
                                            
                                            #if len($fin_stages) and self.has_action($fin_stages)
                                               <div class="sidetabs thin">
                                                    <nav class="sidetab-switch">
                                                        <ul>
                                                            #set $default_tab = True
                                                            #for $i, $stage in enumerate($fin_stages)
                                                                
                                                                #if self.participates($stage)
                                                                    #set $failure = self.has_failure($stage)
                                                                    #set $host = $stage[3].replace('.', '-')
                                                                    <li class="${'failure' if $failure else 'success'}">
                                                                        <a href="#sidetab-inner-suite-fin-${host}-${run.uid}" 
                                                                           class="${'default-sidetab' if $default_tab else ''}">
                                                                                $stage[3]
                                                                        </a>
                                                                    </li>
                                                                    #set $default_tab = False
                                                                #end if
                                                            
                                                            #end for
                                                        </ul>
                                                    </nav>
                                                    
                                                    <section>
                                                    #set $default_tab = True
                                                    #for $i, $stage in enumerate($fin_stages)
                                                        #set $host = $stage[3].replace('.', '-')
                                                        
                                                        #if self.participates($stage)
                                                            <div class="sidetab ${'default-sidetab' if $default_tab else ''}" 
                                                                 id="sidetab-inner-suite-fin-${host}-${run.uid}">        
                                                                <article class="full-block nested light">                                       
                                                                    <div class="article-container">
                                                                       <section>
                                                                            
                                                                              <header>
                                                                                <h2><span>finalized at $stage[0].time[:8] with return code $stage[1][2]</span></h2>
                                                                                
                                                                                <nav class="log-select">
                                                                                    <ul class="tab-switch">
                                                                                        <li>
                                                                                        <a class="default-tab" href="#tab-log-fin-${host}-${run.uid}-default-all">All</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-fin-${host}-${run.uid}-default-important">Important</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-fin-${host}-${run.uid}-default-error">Errors</a>
                                                                                        </li>
                                                                                        <li>
                                                                                        <a href="#tab-log-fin-${host}-${run.uid}-default-warning">Warnings</a>
                                                                                        </li>
                                                                                    </ul>
                                                                                </nav>
                                                                                
                                                                            </header>
                                                                                <form class="log-select">
                                                                                    <label for="whichlog">Select Log:&nbsp;</label>
                                                                                    <select id="whichlog">
                                                                                        
                                                                                        <option class="default-option"
                                                                                                value="tab-log-fin-$host-$run.uid-default">
                                                                                            Session Log
                                                                                        </option>
                                                                                        
                                                                                        #for $i, $logname in enumerate($stage[1][3].iterkeys())
                                                                                            <option value="tab-log-fin-$host-$run.uid-$i">
                                                                                                $logname
                                                                                            </option>
                                                                                        #end for
                                                                                    </select>
                                                                                </form>
                                                                            <section>
                                                                            
                                                                            </section>
                                                                            
                                                                            #set $logs = self.format_log($stage[1][0])
                                                                            <section>
                                                                                <div class="tab default-tab default-log" id="tab-log-fin-${host}-${run.uid}-default-all">
                                                                                    <code>$logs['all']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-fin-${host}-${run.uid}-default-important">
                                                                                    <code>$logs['important']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-fin-${host}-${run.uid}-default-error">
                                                                                    <code>$logs['error']</code>
                                                                                </div>
                                                                                <div class="tab" id="tab-log-fin-${host}-${run.uid}-default-warning">
                                                                                    <code>$logs['warning']</code>
                                                                                </div>
                                                                            </section>
                                                                            
                                                                            
                                                                            #for $i, $log in enumerate($stage[1][3].itervalues())
                                                                                #set $logs = self.format_log($log, custom=True)
                                                                                <section>
                                                                                    <div class="tab default-log" id="tab-log-fin-${host}-${run.uid}-$i-all">
                                                                                        <code>$logs['all']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-fin-${host}-${run.uid}-$i-important">
                                                                                        <code>$logs['important']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-fin-${host}-${run.uid}-$i-error">
                                                                                        <code>$logs['error']</code>
                                                                                    </div>
                                                                                    <div class="tab" id="tab-log-fin-${host}-${run.uid}-$i-warning">
                                                                                        <code>$logs['warning']</code>
                                                                                    </div>
                                                                                </section>
                                                                            #end for
                                                                         
                                                                         </section>
                                                                    </div>
                                                                </article>     
                                                            </div>
                                                            #set $default_tab = False
                                                        #end if
                                                        
                                                    #end for
                                                    </section>
                                               </div>
                                            #else
                                                <div class="notification note">
                                                    <p>
                                                        <strong>Note:</strong> No suite finalization information.
                                                    </p>
                                                </div>
                                            #end if 
                                        </div>    
                                    </section>                              
                                    
                                </div>
                                
                            #end for
                        #end if 
                    </div>
                <!-- /Tab Content -->
            </section>
            <!-- /Article Content -->
        #else
            <div class="notification error">
                <p>
                    <strong>Error:</strong> Test suite not found.
                </p>
            </div>
        #end if
        </div>
        <!-- /Article Container -->

    </article>
    <!-- /Full Content Block -->

</section>
<!-- /Main Content -->

</div>
</body>
